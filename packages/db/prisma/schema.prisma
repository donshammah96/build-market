generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  client
  professional
  admin
}

enum ProjectStatus {
  planning
  in_progress
  completed
  archived
}

enum OrderStatus {
  pending
  paid
  shipped
  delivered
  cancelled
}

enum ReviewType {
  professional
  store
}

enum PaymentStatus {
  success
  failed
  refunded
  pending
}

enum MessageType {
  text
  image
  file
  pdf
  system
}

enum CertificateVerificationStatus {
  pending
  verified
  rejected
}

model User {
  id                  String               @id @default(uuid())
  clerkId             String               @unique
  email               String               @unique
  firstName           String?
  lastName            String?
  phone               String?
  role                UserRole             @default(client)
  isProfileComplete   Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  clientProfile       ClientProfile?
  professionalProfile ProfessionalProfile?
  adminProfile        AdminProfile?
  projects            Project[]            @relation("ClientProjects")
  orders              Order[]              @relation("ClientOrders")
  reviews             Review[]             @relation("Reviewer")
  ideaBooks           IdeaBook[]
  messageThreads      MessageThread[]      @relation("MessageThreadUsers")
  messages            Message[]            @relation("Sender")
  analytics           UserAnalytics[]

  @@index([clerkId])
  @@index([email])
  @@index([role])
}

model ClientProfile {
  userId      String   @id
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  address     String?
  city        String?
  county      String?
  zipCode     String?
  preferences Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProfessionalProfile {
  userId          String        @id
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyName     String
  licenseNumber   String?       @unique
  yearsExperience Int?
  servicesOffered String[]
  portfolioUrl    String?
  bio             String?
  city            String?
  county          String?
  country         String?
  verified        Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  portfolios      Portfolio[]
  projects        Project[]     @relation("ProfessionalProjects")
  orders          Order[]       @relation("ProfessionalOrders")
  reviews         Review[]      @relation("ProfessionalReviews")
  certificates    Certificate[]

  @@index([verified])
  @@index([city])
  @@index([county])
  @@index([companyName])
}

model AdminProfile {
  userId      String   @id
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissions String[]
}

model Project {
  id             String               @id @default(uuid())
  clientId       String
  client         User                 @relation(fields: [clientId], references: [id], onDelete: Cascade, name: "ClientProjects")
  professionalId String?              @map("professionalId")
  professional   ProfessionalProfile? @relation(fields: [professionalId], references: [userId], onDelete: SetNull, name: "ProfessionalProjects")
  title          String
  description    String?
  status         ProjectStatus        @default(planning)
  budget         Float?
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  milestones     ProjectMilestone[]
  messageThreads MessageThread[]

  @@index([clientId])
  @@index([professionalId])
  @@index([status])
  @@index([createdAt])
}

model ProjectMilestone {
  id          String    @id @default(uuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?
  dueDate     DateTime?
  completed   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model IdeaBook {
  id          String   @id @default(uuid())
  clientId    String
  client      User     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  title       String
  description String?
  items       Json // Stores IdeaBookItem array as JSONB
  sharedWith  String[] // UUIDs of users
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Review {
  id             String               @id @default(uuid())
  reviewerId     String
  reviewer       User                 @relation(fields: [reviewerId], references: [id], onDelete: Cascade, name: "Reviewer")
  professionalId String?
  storeId        String?
  professional   ProfessionalProfile? @relation(fields: [professionalId], references: [userId], onDelete: Cascade, name: "ProfessionalReviews")
  store          Store?               @relation(fields: [storeId], references: [id], onDelete: Cascade, name: "StoreReviews")
  type           ReviewType
  rating         Int // 1-5 rating scale
  comment        String?
  approved       Boolean              @default(false)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([type])
  @@index([rating])
  @@index([approved])
  @@index([professionalId])
  @@index([storeId])
}

model Store {
  id          String    @id @default(uuid())
  name        String
  description String?
  address     String
  city        String
  state       String
  zipCode     String
  categories  String[]
  verified    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]
  orders      Order[]   @relation("StoreOrders")
  reviews     Review[]  @relation("StoreReviews")
}

model Product {
  id          String   @id @default(uuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  name        String
  description String?
  price       Float
  imageUrl    String?
  category    String
  inStock     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Order {
  id             String               @id @default(uuid())
  clientId       String
  client         User                 @relation(fields: [clientId], references: [id], onDelete: Cascade, name: "ClientOrders")
  storeId        String?
  store          Store?               @relation(fields: [storeId], references: [id], onDelete: SetNull, name: "StoreOrders")
  professionalId String?
  professional   ProfessionalProfile? @relation(fields: [professionalId], references: [userId], onDelete: SetNull, name: "ProfessionalOrders")
  items          Json // Stores OrderItem array as JSONB
  totalAmount    Float
  status         OrderStatus          @default(pending)
  paymentMethod  String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  payments       Payment[]
}

model Payment {
  id            String        @id @default(uuid())
  orderId       String
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount        Float
  transactionId String        @unique
  status        PaymentStatus @default(pending)
  createdAt     DateTime      @default(now())

  @@index([orderId])
  @@index([status])
  @@index([transactionId])
}

model Portfolio {
  id                String              @id @default(uuid())
  professionalId    String
  professional      ProfessionalProfile @relation(fields: [professionalId], references: [userId], onDelete: Cascade)
  title             String
  description       String?
  images            String[]
  projectType       String
  clientTestimonial String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model MessageThread {
  id            String    @id @default(uuid())
  participants  String[] // UUIDs of users
  users         User[]    @relation("MessageThreadUsers")
  projectId     String?
  project       Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  lastMessage   String?
  lastMessageAt DateTime?
  unreadCount   Json? // Map of userId -> unread count
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  messages      Message[]

  @@index([lastMessageAt])
}

model Message {
  id          String        @id @default(uuid())
  threadId    String
  thread      MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  senderId    String
  sender      User          @relation(fields: [senderId], references: [id], name: "Sender")
  content     String // Encrypted in messaging-service
  type        MessageType   @default(text)
  readBy      String[]      @default([]) // UUIDs of users
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  attachments Attachment[]

  @@index([threadId, createdAt])
  @@index([senderId])
  @@index([createdAt])
}

model Attachment {
  id        String   @id @default(uuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  url       String // Encrypted in messaging-service
  filename  String // Encrypted in messaging-service
  size      Int
  mimeType  String
  createdAt DateTime @default(now())

  @@index([messageId])
}

model UserAnalytics {
  id       String   @id @default(uuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metrics  Json // Stores AnalyticsMetric array as JSONB
  fromDate DateTime
  toDate   DateTime
}

model Certificate {
  id                 String                        @id @default(uuid())
  professionalId     String
  professional       ProfessionalProfile           @relation(fields: [professionalId], references: [userId], onDelete: Cascade)
  name               String
  issuer             String
  issueDate          DateTime?
  expiryDate         DateTime?
  fileUrl            String
  verificationStatus CertificateVerificationStatus @default(pending)
  verifiedAt         DateTime?
  verifiedBy         String? // Admin userId who verified
  notes              String?
  createdAt          DateTime                      @default(now())
  updatedAt          DateTime                      @updatedAt

  @@index([professionalId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([verificationStatus])
  @@index([verifiedBy])
}
